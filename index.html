<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• ULTIMATE HAND PARTICLE MAGIC</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            background: #000;
            color: #fff;
            font-family: 'Arial', sans-serif;
        }
        #container {
            position: fixed;
            width: 100%;
            height: 100%;
        }
        #mainCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #webcamContainer {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 280px;
            height: 210px;
            border: 3px solid #00ff88;
            border-radius: 15px;
            overflow: hidden;
            z-index: 100;
            box-shadow: 0 0 25px #00ff88;
        }
        #webcam {
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            display: block;
        }
        .ui-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 20, 40, 0.95);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #ff00ff;
            max-width: 320px;
            backdrop-filter: blur(10px);
        }
        .title {
            color: #00ffff;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
            text-shadow: 0 0 10px #00ffff;
        }
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .mode-btn {
            padding: 12px 8px;
            background: linear-gradient(45deg, #0066cc, #6600cc);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.5);
        }
        .mode-btn.active {
            background: linear-gradient(45deg, #00ff88, #0088ff);
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 20px #00ff88;
        }
        .control-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 40, 80, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }
        .control-row {
            display: flex;
            align-items: center;
            margin: 12px 0;
        }
        .control-label {
            width: 100px;
            color: #88ffff;
            font-size: 14px;
        }
        .slider-container {
            flex: 1;
            margin: 0 15px;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: linear-gradient(to right, #0066cc, #cc00cc);
            border-radius: 3px;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00ff88;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 10px #00ff88;
        }
        .value-display {
            width: 50px;
            text-align: right;
            color: #ff88ff;
            font-weight: bold;
            font-size: 16px;
        }
        .hand-tracker {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            pointer-events: none;
            z-index: 50;
            transform: translate(-50%, -50%);
            display: none;
        }
        .tracker-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 0.4; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        .tracker-emoji {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            filter: drop-shadow(0 0 10px white);
        }
        .stats-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 10, 30, 0.9);
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #00ff88;
            max-width: 280px;
        }
        .stat-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        .stat-label {
            color: #88ff88;
        }
        .stat-value {
            color: #ffff88;
            font-weight: bold;
        }
        .fps-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #00ff88;
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #00ff88;
        }
        .gesture-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            opacity: 0;
            pointer-events: none;
            z-index: 60;
            transition: all 0.5s;
        }
        .instruction {
            position: absolute;
            top: 50px;
            right: 20px;
            background: rgba(0, 30, 60, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ffaa00;
            max-width: 250px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="mainCanvas"></canvas>
        
        <div id="webcamContainer">
            <video id="webcam" autoplay playsinline muted></video>
        </div>
        
        <div class="ui-panel">
            <div class="title">üéÆ PARTICLE CONTROL</div>
            
            <div class="mode-grid">
                <button class="mode-btn active" onclick="setMode('flow')">üåÄ FLOW</button>
                <button class="mode-btn" onclick="setMode('attract')">‚úä ATTRACT</button>
                <button class="mode-btn" onclick="setMode('repel')">üñêÔ∏è REPEL</button>
                <button class="mode-btn" onclick="setMode('swirl')">üå™Ô∏è SWIRL</button>
                <button class="mode-btn" onclick="setMode('rainbow')">üåà RAINBOW</button>
                <button class="mode-btn" onclick="setMode('explode')">üí• EXPLODE</button>
            </div>
            
            <div class="control-section">
                <div class="control-row">
                    <div class="control-label">Particles</div>
                    <div class="slider-container">
                        <input type="range" id="particleSlider" min="1000" max="15000" value="5000" step="500">
                    </div>
                    <div class="value-display" id="particleValue">5000</div>
                </div>
                
                <div class="control-row">
                    <div class="control-label">Power</div>
                    <div class="slider-container">
                        <input type="range" id="powerSlider" min="0.1" max="3.0" value="1.5" step="0.1">
                    </div>
                    <div class="value-display" id="powerValue">1.5</div>
                </div>
                
                <div class="control-row">
                    <div class="control-label">Size</div>
                    <div class="slider-container">
                        <input type="range" id="sizeSlider" min="0.5" max="5.0" value="2.0" step="0.1">
                    </div>
                    <div class="value-display" id="sizeValue">2.0</div>
                </div>
            </div>
        </div>
        
        <div class="hand-tracker" id="handTracker">
            <div class="tracker-circle"></div>
            <div class="tracker-emoji">üëã</div>
        </div>
        
        <div class="gesture-popup" id="gesturePopup">üëã</div>
        
        <div class="stats-panel">
            <div class="stat-item">
                <span class="stat-label">Hand Status:</span>
                <span class="stat-value" id="handStatus">WAITING</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Gesture:</span>
                <span class="stat-value" id="gestureType">NONE</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Particles:</span>
                <span class="stat-value" id="liveParticleCount">5000</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Mode:</span>
                <span class="stat-value" id="currentMode">FLOW</span>
            </div>
        </div>
        
        <div class="fps-counter">FPS: <span id="fpsValue">0</span></div>
        
        <div class="instruction">
            <div style="color:#ffaa00; font-weight:bold; margin-bottom:8px;">INSTRUCTIONS:</div>
            <div>1. Allow camera access</div>
            <div>2. Show hand to camera</div>
            <div>3. Move hand to control</div>
            <div>4. Use gestures for effects</div>
        </div>
    </div>

    <!-- THREE.JS ONLY - NO EXTERNAL DEPENDENCIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // ========== CONFIGURATION ==========
        const CONFIG = {
            particles: {
                count: 5000,
                size: 2.0,
                power: 1.5,
                attraction: 0.02,
                repulsion: 0.015,
                friction: 0.96
            },
            camera: {
                distance: 35,
                smoothness: 0.1
            }
        };

        // ========== GLOBAL VARIABLES ==========
        let scene, camera, renderer;
        let particleSystem;
        let particles = [];
        let currentMode = 'flow';
        let time = 0;
        let fps = 0;
        let frameCount = 0;
        let lastFpsUpdate = 0;
        
        // Hand tracking
        let video;
        let handCanvas;
        let handCtx;
        let handPosition = { x: 0.5, y: 0.5 };
        let lastHandPosition = { x: 0.5, y: 0.5 };
        let handVelocity = { x: 0, y: 0 };
        let currentGesture = 'none';
        let isHandDetected = false;
        let lastGestureTime = 0;

        // ========== INITIALIZE THREE.JS ==========
        function initThreeJS() {
            // Create scene
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x000000, 10, 100);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, CONFIG.camera.distance);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('mainCanvas'),
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000);
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);
            
            // Create particle system
            createParticleSystem();
            
            updateStatus('Hand Status', 'INITIALIZED');
        }

        // ========== CREATE PARTICLE SYSTEM ==========
        function createParticleSystem() {
            // Remove old system if exists
            if (particleSystem) {
                scene.remove(particleSystem);
                particleSystem.geometry.dispose();
                particleSystem.material.dispose();
            }
            
            // Initialize particles
            particles = [];
            const positions = new Float32Array(CONFIG.particles.count * 3);
            const colors = new Float32Array(CONFIG.particles.count * 3);
            const sizes = new Float32Array(CONFIG.particles.count);
            
            for (let i = 0; i < CONFIG.particles.count; i++) {
                // Create spherical distribution
                const radius = Math.random() * 20;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                
                const x = radius * Math.sin(phi) * Math.cos(theta);
                const y = radius * Math.sin(phi) * Math.sin(theta);
                const z = radius * Math.cos(phi);
                
                particles.push({
                    x, y, z,
                    vx: 0, vy: 0, vz: 0,
                    originalX: x,
                    originalY: y,
                    originalZ: z,
                    size: Math.random() * 0.8 + 0.3,
                    color: new THREE.Color(),
                    phase: Math.random() * Math.PI * 2
                });
                
                // Set initial positions
                positions[i * 3] = x;
                positions[i * 3 + 1] = y;
                positions[i * 3 + 2] = z;
                
                // Set colors based on position
                const hue = (Math.atan2(y, x) + Math.PI) / (2 * Math.PI);
                particles[i].color.setHSL(hue, 0.9, 0.5);
                
                colors[i * 3] = particles[i].color.r;
                colors[i * 3 + 1] = particles[i].color.g;
                colors[i * 3 + 2] = particles[i].color.b;
                
                sizes[i] = particles[i].size * CONFIG.particles.size;
            }
            
            // Create geometry
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
            
            // Create material
            const material = new THREE.PointsMaterial({
                size: CONFIG.particles.size,
                vertexColors: true,
                transparent: true,
                opacity: 0.9,
                sizeAttenuation: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            
            particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);
            
            // Update UI
            document.getElementById('liveParticleCount').textContent = CONFIG.particles.count.toLocaleString();
            updateStatus('Hand Status', 'READY');
        }

        // ========== INITIALIZE CAMERA AND HAND TRACKING ==========
        async function initCamera() {
            try {
                video = document.getElementById('webcam');
                
                // Get camera access
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                updateStatus('Hand Status', 'CAMERA READY');
                
                // Start hand detection
                startHandDetection();
                
            } catch (error) {
                console.error('Camera error:', error);
                updateStatus('Hand Status', 'CAMERA FAILED - USING MOUSE');
                setupMouseControl();
            }
        }

        // ========== SIMPLE HAND DETECTION (COLOR-BASED) ==========
        function startHandDetection() {
            // Create canvas for hand detection
            handCanvas = document.createElement('canvas');
            handCtx = handCanvas.getContext('2d');
            
            // Set canvas size
            handCanvas.width = 160;
            handCanvas.height = 120;
            
            let lastFrame = null;
            
            function detectHandLoop() {
                if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                    requestAnimationFrame(detectHandLoop);
                    return;
                }
                
                // Draw video to canvas (smaller for performance)
                handCtx.save();
                handCtx.scale(-1, 1);
                handCtx.drawImage(video, -handCanvas.width, 0, handCanvas.width, handCanvas.height);
                handCtx.restore();
                
                const frame = handCtx.getImageData(0, 0, handCanvas.width, handCanvas.height);
                
                // Simple skin color detection
                let skinPixels = 0;
                let totalX = 0;
                let totalY = 0;
                
                for (let i = 0; i < frame.data.length; i += 4) {
                    const r = frame.data[i];
                    const g = frame.data[i + 1];
                    const b = frame.data[i + 2];
                    
                    // Skin color detection (simple)
                    if (r > 100 && g > 50 && g < 200 && b < 150 && r > g && r > b) {
                        skinPixels++;
                        const pixelIndex = i / 4;
                        totalX += pixelIndex % handCanvas.width;
                        totalY += Math.floor(pixelIndex / handCanvas.width);
                    }
                }
                
                // If enough skin pixels detected
                if (skinPixels > 500) {
                    isHandDetected = true;
                    
                    // Calculate hand center
                    handPosition.x = (totalX / skinPixels) / handCanvas.width;
                    handPosition.y = (totalY / skinPixels) / handCanvas.height;
                    
                    // Calculate velocity
                    handVelocity.x = (handPosition.x - lastHandPosition.x) * 10;
                    handVelocity.y = (handPosition.y - lastHandPosition.y) * 10;
                    
                    lastHandPosition.x = handPosition.x;
                    lastHandPosition.y = handPosition.y;
                    
                    // Detect gesture based on velocity
                    detectGesture();
                    
                    // Update hand tracker
                    updateHandTracker();
                    
                    updateStatus('Hand Status', 'HAND DETECTED');
                    document.getElementById
